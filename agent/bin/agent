#!/var/vmc/bosh/bin/ruby
#
ENV["BUNDLE_GEMFILE"] ||= File.expand_path("../../Gemfile", __FILE__)

require "rubygems"
require "bundler/setup"

$LOAD_PATH.unshift(File.dirname(__FILE__) + "/../lib")

require "agent"

# Defaults
options = {
  "configure" => false,
  "logging"   => { "level" => "DEBUG" },
  "redis"     => { "host" => "localhost" },
  "agent_id"  => "not_configured",
  "blobstore" => {}, # FIXME - make configurable
  "base_dir"  => "/var/vmc"
}

opts = OptionParser.new do |opts|
  opts.on("-c", "--configure", "Invoke") do |opt|
    options["configure"] = true
  end

  opts.on("-a", "--agent_id String", "Agent ID") do |opt|
    options["agent_id"] = opt
  end

  opts.on("-b", "--base_dir String", "Base directory") do |opt|
    options["base_dir"] = opt
  end

  opts.on("-r", "--redis String", "Redis host:port") do |opt|
    host, port = opt.split(":", 2)
    options["redis"] = { "host" => host, "port" => port }
  end

  # Needed this customization for integration tests, quirky but seems to work
  opts.on("-s", "--blobstore String", "Blobstore options") do |opt|
    credentials, endpoint = opt.split("@", 2)
    user, password = credentials.split(":", 2)
    options["blobstore"] = { "endpoint" => endpoint, "user" => user, "password" => password }
  end
  
end
opts.parse!(ARGV.dup)

Bosh::Agent.run(options)
